{% extends "base.html" %}

{% block title %}Employer Dashboard - ShramBandhu{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

    {# --- Welcome Header & Quick Actions --- #}
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Employer Dashboard</h1>
            <p class="text-gray-600 mt-1">Welcome back, {{ current_user.org_name or current_user.name }}!</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <a href="{{ url_for('employer.post_job') }}"
               class="w-full sm:w-auto inline-flex justify-center items-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                <svg class="w-5 h-5 mr-2 -ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                Post New Job
            </a>
             <a href="{{ url_for('employer.payment_history') }}"
               class="w-full sm:w-auto inline-flex justify-center items-center px-5 py-2.5 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                 <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Payment History
            </a>
        </div>
    </div>

    {# --- Quick Stats Row --- #}
     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
         {# Stat Card: Total Jobs #}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition duration-200">
            <div class="flex items-center justify-between">
                <div><p class="text-sm font-medium text-gray-500">Total Jobs Posted</p><p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.get('total_jobs', 0) }}</p></div>
                <div class="bg-indigo-100 p-3 rounded-full"><svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div>
            </div>
        </div>
         {# Stat Card: Active Jobs #}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition duration-200">
             <div class="flex items-center justify-between">
                 <div><p class="text-sm font-medium text-gray-500">Active Jobs</p><p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.get('active_jobs', 0) }}</p></div>
                  <div class="bg-blue-100 p-3 rounded-full"><svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 13v-1m4 1v-3m4 3V8M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg></div>
             </div>
         </div>
          {# Stat Card: Pending Applications #}
         <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition duration-200">
             <div class="flex items-center justify-between">
                 <div><p class="text-sm font-medium text-gray-500">Pending Applications</p><p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.get('pending_applications', 0) }}</p></div>
                  <div class="bg-yellow-100 p-3 rounded-full"><svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg></div>
             </div>
         </div>
          {# Stat Card: Total Spent #}
         <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition duration-200">
             <div class="flex items-center justify-between">
                 <div><p class="text-sm font-medium text-gray-500">Total Spent (Verified)</p><p class="text-2xl font-bold text-gray-900 mt-1">â‚¹{{ "{:,.0f}".format(stats.get('total_spent', 0)) }}</p></div>
                  <div class="bg-green-100 p-3 rounded-full"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
             </div>
         </div>
     </div>

     {# --- Main Content Grid (2 Columns) --- #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        {# --- Wider Column (Job Lists & Actions) --- #}
        <div class="lg:col-span-2 space-y-8">

             {# Jobs Requiring Action Card #}
             {% if jobs_with_pending_apps or (completed_jobs | rejectattr('has_rated') | list) %}
             <div class="bg-white rounded-xl shadow-md border border-yellow-300">
                 <div class="flex justify-between items-center px-6 py-4 border-b border-yellow-200 bg-yellow-50 rounded-t-xl">
                     <h2 class="text-lg font-semibold text-yellow-800 flex items-center"><i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i> Action Needed</h2>
                 </div>
                 <div class="p-6 space-y-4">
                     {# Pending Applications #}
                     {% if jobs_with_pending_apps %}
                     <div> <h3 class="text-sm font-medium text-gray-500 mb-2">Review Applications</h3> <ul class="space-y-2"> {% for job in jobs_with_pending_apps %} <li class="border border-gray-200 rounded-lg p-3 flex flex-col sm:flex-row justify-between items-center gap-2 hover:bg-gray-50"> <div class="flex-1 min-w-0"> <a href="{{ url_for('employer.view_job', job_id=job.id) }}" class="font-medium text-gray-800 hover:underline text-sm sm:text-base">{{ job.title }}</a> <p class="text-xs text-gray-500">{{ job.address | truncate(40) }}</p> </div> <a href="{{ url_for('employer.view_applications', job_id=job.id) }}" class="w-full sm:w-auto ml-0 sm:ml-4 text-center sm:text-left inline-flex items-center justify-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-yellow-700 bg-yellow-100 hover:bg-yellow-200 transition whitespace-nowrap"> {{ job.pending_apps_count }} Pending App{% if job.pending_apps_count != 1 %}s{% endif %} </a> </li> {% endfor %} </ul> </div>
                     {% endif %}
                     {# Completed Jobs Needing Rating/Payment #}
                     {% set completed_needing_action = completed_jobs | rejectattr('has_rated') | list %}
                     {% if completed_needing_action %}
                     <div class="pt-4 border-t border-gray-100"> <h3 class="text-sm font-medium text-gray-500 mb-2">Complete & Rate Workers</h3> <ul class="space-y-2"> {% for job in completed_needing_action %} <li class="border border-gray-200 rounded-lg p-3 flex flex-col sm:flex-row justify-between items-center gap-2 hover:bg-gray-50"> <div class="flex-1 min-w-0"> <a href="{{ url_for('employer.view_job', job_id=job.id) }}" class="font-medium text-gray-800 hover:underline text-sm sm:text-base">{{ job.title }}</a> <p class="text-xs text-gray-500">Worker: {{ job.accepted_worker().name | truncate(20) if job.accepted_worker() else 'N/A' }}</p> </div> <div class="ml-0 sm:ml-4 space-x-2 flex-shrink-0 mt-2 sm:mt-0"> <a href="{{ url_for('employer.initiate_payment', application_id=job.accepted_application().id) }}" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 transition"> Pay/Verify </a> <a href="{{ url_for('employer.rate_worker', job_id=job.id) }}" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 transition"> Rate Worker </a> </div> </li> {% endfor %} </ul> </div>
                     {% endif %}
                 </div>
             </div>
             {% endif %}

            {# Active & In-Progress Jobs Card #}
            <div class="bg-white rounded-xl shadow-md border border-gray-200">
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">Current Postings</h2>
                    <span class="text-sm text-gray-500">{{ active_jobs|length + in_progress_jobs|length }} Open</span>
                </div>
                 <div class="p-6">
                     {% if not active_jobs and not in_progress_jobs %}
                         <p class="text-gray-600 text-center py-6">You have no active or in-progress jobs.</p> <div class="text-center"> <a href="{{ url_for('employer.post_job') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">Post a Job</a> </div>
                     {% else %}
                         <ul class="space-y-5">
                              {% for job in in_progress_jobs %} <li class="border rounded-lg p-4 hover:bg-gray-50 transition duration-200 ease-in-out shadow-sm flex flex-col sm:flex-row justify-between items-start gap-4 border-l-4 border-yellow-400"> <div class="flex-1 min-w-0"> <a href="{{ url_for('employer.view_job', job_id=job.id) }}" class="font-semibold text-base text-gray-800 hover:underline truncate">{{ job.title }}</a> <p class="text-sm text-gray-500 mt-1">Worker: {{ job.accepted_worker().name or 'N/A' }}</p> <p class="text-sm text-gray-500 mt-1 flex items-center gap-1 text-ellipsis overflow-hidden whitespace-nowrap"> <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> {{ job.address | truncate(40) if job.address else 'Location' }} </p> </div> <div class="text-left sm:text-right flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0"> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">In Progress</span> <p class="text-xs text-gray-400 mt-1">Posted: {{ job.created_at | time_ago }}</p> <a href="{{ url_for('employer.view_job', job_id=job.id) }}" class="text-xs mt-2 inline-block bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300 transition">View Details</a> </div> </li> {% endfor %}
                              {% for job in active_jobs %} <li class="border rounded-lg p-4 hover:bg-gray-50 transition duration-200 ease-in-out shadow-sm flex flex-col sm:flex-row justify-between items-start gap-4 border-l-4 border-blue-400"> <div class="flex-1 min-w-0"> <a href="{{ url_for('employer.view_job', job_id=job.id) }}" class="font-semibold text-base text-gray-800 hover:underline truncate">{{ job.title }}</a> <p class="text-sm text-gray-500 mt-1">{{ job.job_type | title }}</p> <p class="text-sm text-gray-500 mt-1 flex items-center gap-1 text-ellipsis overflow-hidden whitespace-nowrap"> <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> {{ job.address | truncate(40) if job.address else 'Location' }} </p> </div> <div class="text-left sm:text-right flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0"> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Active</span> <p class="text-xs text-gray-400 mt-1">Posted: {{ job.created_at | time_ago }}</p> <a href="{{ url_for('employer.view_applications', job_id=job.id) }}" class="text-xs mt-2 inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-md hover:bg-blue-200 transition font-medium"> {{ job.total_apps_count }} App{% if job.total_apps_count != 1 %}s{% endif %} {% if job.pending_apps_count > 0 %}({{ job.pending_apps_count }} New){% endif %} </a> </div> </li> {% endfor %}
                         </ul>
                     {% endif %}
                 </div>
            </div> {# End Active/In-Progress Card #}

        </div> {# End Wider Column #}

        {# --- Narrower Column (Notifications, Completed Summary) --- #}
        <div class="lg:col-span-1 space-y-6">
             {# Recent Notifications Card #}
             <div class="bg-white rounded-xl shadow-sm border border-gray-200"> <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200"> <h2 class="text-lg font-semibold text-gray-800">Notifications</h2> <a href="{{ url_for('employer.notifications') }}" class="text-xs font-medium text-blue-600 hover:underline">View All</a> </div> <div class="p-6"> {% if recent_notifications %} <ul class="space-y-3 max-h-60 overflow-y-auto"> {% for notification in recent_notifications %} <li class="text-sm border-b border-gray-100 pb-2 last:pb-0 last:border-0"> <p class="text-gray-800 {% if not notification.is_read %}font-semibold{% endif %}">{{ notification.message }}</p> <p class="text-xs text-gray-400 mt-0.5">{{ notification.created_at | time_ago }}</p> </li> {% endfor %} </ul> {% else %} <p class="text-sm text-gray-500 text-center py-4">No recent notifications.</p> {% endif %} </div> </div>
             {# Completed Jobs Summary Card #}
              <div class="bg-white rounded-xl shadow-sm border border-gray-200"> <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200"> <h2 class="text-lg font-semibold text-gray-800">Completed Jobs</h2> {# Link to full list? #} </div> <div class="p-6"> {% if completed_jobs %} <ul class="space-y-3 max-h-72 overflow-y-auto"> {% for job in completed_jobs[:5] %} <li class="text-sm border-b border-gray-100 pb-2 last:pb-0 last:border-0"> <div class="flex justify-between items-center"> <a href="{{ url_for('employer.view_job', job_id=job.id) }}" class="text-gray-800 hover:underline truncate pr-2">{{ job.title }}</a> {% if not job.has_rated %} <a href="{{ url_for('employer.rate_worker', job_id=job.id) }}" class="text-xs text-blue-600 hover:underline flex-shrink-0">Rate</a> {% else %} <span class="text-xs text-green-600 flex-shrink-0">Rated</span> {% endif %} </div> <p class="text-xs text-gray-500 mt-0.5">Worker: {{ job.accepted_worker().name | truncate(20) if job.accepted_worker() else 'N/A' }}</p> </li> {% endfor %} </ul> {% if completed_jobs|length > 5 %} <div class="text-center mt-4"> <a href="#" class="text-xs font-medium text-blue-600 hover:underline">View All Completed Jobs</a> </div> {% endif %} {% else %} <p class="text-sm text-gray-500 text-center py-4">No jobs completed yet.</p> {% endif %} </div> </div>
        </div> {# End Narrower Column #}

    </div> {# End Main Content Grid #}

</div> {# End Container #}
{% endblock %}

{% block scripts %}
{{ super() }}
{# Add any dashboard specific JS if needed #}
{% endblock %}